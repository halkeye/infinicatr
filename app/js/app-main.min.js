'use strict';
require('../../node_modules/loaders.css/loaders.css');
require('../css/style.scss');

(function() {
  let size = 60;
  /* hack to require them all */
  require('../icons/icon-' + size + '.png');
  require('../manifest.webapp');
})();

require('file?name=favicon.ico!../favicon.ico');

var Promise = require('bluebird');
var Mousetrap = require('mousetrap');
var $ = require('jquery');
//require('touchswipe')($);
//window.jQuery = $;

var config = {};
config.flickr_key = '850775ffc1d6d95478d78bee0fdf4971';
config.pending_message = 'Please wait. Fetching more content';
config.page_size = 10;
config.pending_photos_threshold = Math.floor(config.page_size * 1 / 3);
config.max_photos = config.page_size * 3;

var $pending = $('#loading_flickr_indicator').hide();

var page = 1;
var pendingMorePhotos = 0;
var photos = [];

$(window).on('resize', function() {
  var dimension = Math.min($('.main').height(), $('.main').width());
  $('.flipper').css({
    height: dimension,
    width: dimension
  });
}).trigger('resize');

class Infinicatr {
  constructor() {
    this.timeout = 0;
  }

  changePhoto() {
    if (this.timeout) {
      clearTimeout(this.timeout);
    }
    this.timeout = 0;

    var flipper = $('.flipper');
    var side = $('.back');

    if (flipper.is('.flipped')) {
      side = $('.front');
    }

    var photo = photos.pop();
    if (photos.length <= 3) {
      this.getMorePhotos();
    }
    if (!photo) { return; }
    side.css('background-image', 'url(' + photo.url_z + ')');

    var img = new Image();
    img.src = photo.url_z;
    img.onload = () => {
      flipper.toggleClass('flipped');
      this.timeout = setTimeout(this.changePhoto.bind(this), 3000);
    };
    img.onerror = () => {
      this.changePhoto();
    };
  }

  getMorePhotos() {
    return new Promise(function(resolve, reject) {
      if (pendingMorePhotos) { return resolve(); }
      /* Fetching photos! PLEASE WAIT! */
      pendingMorePhotos = 1;
      var query = {
        dataType: 'jsonp',
        jsonp: 'jsoncallback',
        beforeSend: function() {
          $pending.show();
        },
        complete: function() {
          pendingMorePhotos = 0;
          $pending.hide();
        },
        error: function() {
          reject();
        },
        success: function(data) {

          data.photos.photo.forEach(function(photo) {
            if (!photo.url_z) { return; }
            photos.push(photo);
          });
          resolve();
        },
        data: {
          'api_key': config.flickr_key,
          'content_type': '1', // 1 = photos only
          'extras': ['url_z', 'media'].join(','),
          'format': 'json',
          'method': 'flickr.photos.search',
          'media': 'photos',
          'page': page,
          'per_page': config.page_size,
          'safe_search': '1', // 1 = safe search
          'tags': 'cats'
        }
      };
      $.ajax('https://api.flickr.com/services/rest/', query);
    });
  }
}

var app = new Infinicatr();
app.getMorePhotos().then(function() {
  app.changePhoto();
});

Mousetrap.bind('right', app.changePhoto.bind(app));
Mousetrap.bind('space', app.changePhoto.bind(app));
